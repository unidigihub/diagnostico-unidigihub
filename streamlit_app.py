import streamlit as st
import firebase_admin
from firebase_admin import credentials, firestore
import json
import time

# --- INICIALIZACI√ìN DE FIREBASE (CON LA CORRECCI√ìN FINAL) ---
def initialize_firebase():
    try:
        creds_from_secrets = st.secrets["firebase_credentials"]
        if isinstance(creds_from_secrets, str):
            creds_dict = json.loads(creds_from_secrets)
        else:
            creds_dict = dict(creds_from_secrets)
        
        # LA CORRECCI√ìN CLAVE: Le decimos expl√≠citamente cu√°l es el ID del proyecto.
        # Esto evita que el programa se confunda y busque el servidor de metadatos.
        project_id = creds_dict.get("project_id")
        
        cred = credentials.Certificate(creds_dict)
        
        if not firebase_admin._apps:
            firebase_admin.initialize_app(cred, {
                'projectId': project_id,
            })
            
    except Exception as e:
        st.error(f"Error CR√çTICO al conectar con la base de datos: {e}")
        st.stop()

initialize_firebase()
db = firestore.client()

# --- CONFIGURACI√ìN DE P√ÅGINA Y ESTADO DE SESI√ìN ---
st.set_page_config(page_title="Diagn√≥stico UniDigiHub", layout="centered")

if "current_section" not in st.session_state:
    st.session_state.current_section = 1
if "firestore_doc_id" not in st.session_state:
    st.session_state.firestore_doc_id = None

# --- T√çTULO Y BARRA DE PROGRESO ---
st.title("üìù Diagn√≥stico UniDigiHub LATAM")
# --- BARRA DE PROGRESO CORREGIDA ---
total_sections = 7
progress_text = f"Progreso: Secci√≥n {st.session_state.current_section} de {total_sections}"
# L√≥gica para que la barra no muestre un progreso mayor al 100% si hay m√°s secciones
current_progress = st.session_state.current_section / total_sections
st.progress(current_progress, text=progress_text)
st.markdown("---")


# --- SECCI√ìN 1: DATOS DEMOGR√ÅFICOS ---
if st.session_state.current_section == 1:
    st.header("Secci√≥n 1: Datos Demogr√°ficos")
    # --- TEXTO DE BIENVENIDA CORREGIDO ---
    st.markdown("""
    ### üëã ¬°Bienvenida y bienvenido! 
    Este autodiagn√≥stico tiene como prop√≥sito conocerte mejor para ayudarte a identificar tu punto de partida en el mundo digital. A trav√©s de 7 secciones breves, exploraremos tus intereses, habilidades y contexto local para recomendarte una ruta de aprendizaje personalizada dentro de UniDigiHub.

    üí° **Tu participaci√≥n nos permitir√° dise√±ar experiencias formativas m√°s inclusivas, √∫tiles y adaptadas a tu realidad.**

    No se requiere experiencia previa. Solo responde con sinceridad üòä
    """)

    with st.form("form_s1"):
        paises = ["", "M√©xico (Mƒìxihco)", "Colombia", "Chile", "Brasil", "Argentina", "Costa Rica", "Ecuador", "El Salvador", "Per√∫"]
        st.selectbox("1. ¬øEn qu√© pa√≠s resides?", paises, key="s1_pais")
        st.text_input("2. Departamento o Estado donde vives", key="s1_depto")
        st.text_input("3. Municipio o comunidad", key="s1_comunidad")
        # --- EDAD M√çNIMA CORREGIDA ---
        st.slider("4. ¬øCu√°l es tu edad?", min_value=25, max_value=90, value=25, step=1, key="s1_edad")
        st.selectbox("5. ¬øCon qu√© g√©nero te identificas?", ["", "Femenino", "Masculino", "No binario", "Prefiero no decir", "Muxe (zapoteco)", "Otro"], key="s1_genero")
        st.selectbox("6. ¬øCu√°l es tu nivel educativo m√°s alto alcanzado?", ["", "Primaria incompleta", "Primaria completa", "Secundaria", "T√©cnico", "Universitario üéì", "Posgrado"], key="s1_educacion")
        st.multiselect("7. ¬øCu√°l es tu situaci√≥n laboral actual?", ["Agricultura de subsistencia", "Empleo informal", "Estudiante", "Desempleado", "Trabajo remoto"], key="s1_laboral")
        st.multiselect("8. ¬øQu√© acceso tecnol√≥gico tienes actualmente?", ["üì± Tel√©fono m√≥vil (sin internet)", "üì±üíª Tel√©fono con internet", "üíª Computadora/Tablet", "üì∂ Internet estable en casa", "‚ùå Ninguno"], key="s1_tecnologia")
        
        submitted_s1 = st.form_submit_button("Guardar y Continuar")

    if submitted_s1:
        campos_obligatorios = {
            "Pa√≠s": st.session_state.s1_pais, "Departamento o Estado": st.session_state.s1_depto,
            "Municipio o comunidad": st.session_state.s1_comunidad, "G√©nero": st.session_state.s1_genero,
            "Nivel educativo": st.session_state.s1_educacion
        }
        campos_faltantes = [nombre for nombre, valor in campos_obligatorios.items() if not valor]

        if campos_faltantes:
            st.error(f"üö® ¬°Atenci√≥n! Por favor, completa los siguientes campos para continuar: **{', '.join(campos_faltantes)}**.")
        else:
            doc_data = {
                "seccion1_demograficos": {
                    "pais": st.session_state.s1_pais, "departamento": st.session_state.s1_depto,
                    "comunidad": st.session_state.s1_comunidad, "edad": st.session_state.s1_edad,
                    "genero": st.session_state.s1_genero, "nivel_educativo": st.session_state.s1_educacion,
                    "situacion_laboral": st.session_state.s1_laboral, "acceso_tecnologia": st.session_state.s1_tecnologia,
                }, "timestamp_inicio": firestore.SERVER_TIMESTAMP
            }
            _, doc_ref = db.collection("respuestas_diagnostico_unificado").add(doc_data)
            st.session_state.firestore_doc_id = doc_ref.id
            st.session_state.current_section = 2
            st.success("‚úÖ ¬°Secci√≥n 1 guardada! Avanzando...")
            time.sleep(2)
            st.rerun()

# --- SECCI√ìN 2: PROBLEM√ÅTICAS LOCALES ---
elif st.session_state.current_section == 2:
    st.header("Secci√≥n 2: Problem√°ticas Locales")
    with st.form("form_s2"):
        st.text_area("1. Describe el problema principal que afecta a tu comunidad", placeholder='Ej: "Sequ√≠a en cultivos"', key="s2_problema")
        st.multiselect("2. ¬øCon qu√© sectores se relaciona este problema?", ["Agricultura y tecnolog√≠a", "Finanzas digitales", "Salud comunitaria", "Energ√≠a limpia"], key="s2_sectores")
        st.slider("3. Impacto del problema en tu comunidad (1=Bajo, 5=Cr√≠tico)", 1, 5, 3, key="s2_impacto")
        submitted_s2 = st.form_submit_button("Guardar y Continuar")
    if submitted_s2:
        if not st.session_state.s2_problema: st.warning("Por favor, describe el problema principal.")
        else:
            doc_ref = db.collection("respuestas_diagnostico_unificado").document(st.session_state.firestore_doc_id)
            doc_ref.update({"seccion2_problematicas": {"problema_principal": st.session_state.s2_problema, "sectores_relacionados": st.session_state.s2_sectores, "impacto_escala": st.session_state.s2_impacto}})
            st.session_state.current_section = 3
            st.success("‚úÖ ¬°Secci√≥n 2 guardada! Avanzando...")
            time.sleep(1)
            st.rerun()

# --- SECCI√ìN 3: INTERESES PROFESIONALES ---
elif st.session_state.current_section == 3:
    st.header("Secci√≥n 3: Intereses Profesionales")
    with st.form("form_s3"):
        st.selectbox("1. ¬øCu√°l de estos sectores te atrae m√°s?", ["", "AgriTech (Agricultura)", "FinTech (Finanzas)", "HealthTech (Salud)", "Energ√≠as Renovables"], key="s3_sector_interes")
        st.radio("2. ¬øCu√°l es tu nivel de experiencia en proyectos tecnol√≥gicos?", ["**UniExplorador** (Ninguna o baja experiencia)", "**UniCreador** (Experiencia b√°sica)", "**UniVisionario** (Experiencia avanzada)"], key="s3_experiencia")
        submitted_s3 = st.form_submit_button("Guardar y Continuar")
    if submitted_s3:
        if not st.session_state.s3_sector_interes: st.warning("Por favor, selecciona un sector de inter√©s.")
        else:
            nivel_autodeclarado = st.session_state.s3_experiencia.split("**")[1]
            doc_ref = db.collection("respuestas_diagnostico_unificado").document(st.session_state.firestore_doc_id)
            doc_ref.update({"seccion3_intereses": {"sector_interes_principal": st.session_state.s3_sector_interes, "nivel_autodeclarado": nivel_autodeclarado}})
            st.session_state.current_section = 4
            st.success("‚úÖ ¬°Secci√≥n 3 guardada! Una m√°s y terminamos.")
            time.sleep(1)
            st.rerun()

# --- SECCI√ìN 4: HABILIDADES T√âCNICAS Y BLANDAS ---
elif st.session_state.current_section == 4:
    st.header("Secci√≥n 4: Habilidades y Competencias")
    with st.form("form_s4"):
        st.subheader("Autoevaluaci√≥n de Habilidades T√©cnicas")
        st.slider("1. En una escala de 1 (Nada) a 5 (Mucho), ¬øqu√© tan c√≥modo te sientes con la programaci√≥n o el an√°lisis de datos?", 1, 5, 2, key="s4_autoeval_tech")
        st.subheader("Herramientas Conocidas")
        st.multiselect("2. Marca las herramientas o conceptos que conozcas", ["Sensores IoT", "Drones", "Plataformas de pago", "Blockchain", "Apps de Telemedicina", "Simulaci√≥n de energ√≠a"], key="s4_herramientas")
        st.subheader("Habilidades Blandas")
        st.radio("3. Imagina que tu equipo discute sobre qu√© m√©todo usar en un proyecto. ¬øQu√© har√≠as?", ["A) Dejo que otros decidan.", "B) Busco un consenso escuchando a todos.", "C) Analizo los datos y presento la soluci√≥n m√°s l√≥gica."], key="s4_situacion_equipo")
        submitted_s4 = st.form_submit_button("Finalizar Diagn√≥stico")
    if submitted_s4:
        doc_ref = db.collection("respuestas_diagnostico_unificado").document(st.session_state.firestore_doc_id)
        doc_ref.update({"seccion4_habilidades": {"autoevaluacion_tech": st.session_state.s4_autoeval_tech, "herramientas_conocidas": st.session_state.s4_herramientas, "respuesta_habilidad_blanda": st.session_state.s4_situacion_equipo[0]}, "timestamp_final": firestore.SERVER_TIMESTAMP, "estado": "Completado"})
        st.session_state.current_section = 5
        st.success("‚úÖ ¬°Diagn√≥stico finalizado! Calculando tu perfil...")
        time.sleep(2)
        st.rerun()

# --- L√ìGICA PARA MOSTRAR LA P√ÅGINA FINAL ---
# Esta l√≥gica ahora mostrar√° la p√°gina final cuando se hayan completado las 4 secciones que tenemos construidas.
# Y se detendr√° all√≠ hasta que construyamos las secciones 5, 6 y 7.
elif st.session_state.current_section == 5:
    st.header("üéâ ¬°Diagn√≥stico Completado! üéâ")
    st.balloons()
    st.markdown("¬°Muchas gracias por completar tu diagn√≥stico! Hemos guardado tus respuestas de forma segura.")
    st.info(f"Tu ID de registro √∫nico es: **{st.session_state.firestore_doc_id}**")
    st.markdown("El siguiente paso ser√° analizar tus respuestas para darte un resultado. ¬°Estamos trabajando en ello!")
